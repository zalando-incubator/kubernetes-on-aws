apiVersion: v1
kind: ConfigMap
metadata:
  name: deployment-config
  namespace: kube-system
data:
  aws-account-id: "{{accountID .Cluster.InfrastructureAccount}}"
  cluster-alias: "{{.Cluster.Alias}}"
  cluster-vpc-id: "{{.Cluster.ConfigItems.vpc_id}}"
  scalyr-team-token: "{{.Cluster.ConfigItems.scalyr_team_token}}"
  create-namespaces: "true"
  aws-available: "true"
  worker-role-arn: "arn:aws:iam::{{accountID .Cluster.InfrastructureAccount}}:role/{{.Cluster.LocalID}}-worker"
{{- if eq .Cluster.Provider "zalando-eks" }}
  {{ $eks_oidc_issuer := index (split .Cluster.ConfigItems.eks_oidc_issuer_url "//") 1 }}
  oidc-provider-arn: "arn:aws:iam::{{accountID .Cluster.InfrastructureAccount}}:oidc-provider/{{$eks_oidc_issuer}}"
  oidc-subject-key: "{{$eks_oidc_issuer}}:sub"
{{- else }}
  oidc-provider-arn: "arn:aws:iam::{{accountID .Cluster.InfrastructureAccount}}:oidc-provider/{{.Cluster.LocalID}}.{{.Cluster.Alias}}.zalan.do"
  oidc-subject-key: "{{.Cluster.LocalID}}.{{.Cluster.Alias}}.zalan.do:sub"
{{- end }}
  s3-bucket-name: "zalando-deployment-service-{{accountID .Cluster.InfrastructureAccount}}-{{.Cluster.LocalID}}"
  status-service-url: "https://deployment-status-svc-{{.Cluster.Alias}}.{{.Values.hosted_zone}}"
  deployment-role-arn: "arn:aws:iam::{{accountID .Cluster.InfrastructureAccount}}:role/{{.Cluster.LocalID}}-deployment-service-deployment"
{{- if eq .Cluster.ConfigItems.deployment_service_ml_experiments_enabled "true"}}
  ml-experiment-deployment-role-arn: "arn:aws:iam::{{accountID .Cluster.InfrastructureAccount}}:role/{{.Cluster.LocalID}}-deployment-service-ml-experiment-deployment"
{{- end }}
  cloudformation-enable-auto-expand: "{{.Cluster.ConfigItems.deployment_service_cf_auto_expand_enabled}}"
  cloudformation-update-source-branch-changes: "{{.Cluster.ConfigItems.deployment_service_cf_update_source_branch_changes}}"
  skip-mustache: "{{.Cluster.ConfigItems.deployment_service_skip_mustache_rendering}}"
  cleanup-namespace-prefix: "d-"
